<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meeting Manager</title>
    <script src="https://apis.google.com/js/api.js" onload="handleGoogleAPILoad()"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.5.0/ical.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .btn-large { min-height: 60px; font-size: 18px; }
        .btn-action { min-height: 56px; font-size: 16px; }
        .nav-btn { min-height: 64px; min-width: 64px; font-size: 24px; }
        .meeting-time { font-size: 24px; font-weight: 700; }
        .meeting-city { font-size: 20px; font-weight: 500; }
        .date-display { font-size: 28px; font-weight: 700; }
        .field-label { font-size: 16px; font-weight: 600; }
        .field-value { font-size: 18px; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; }
        .calendar-day { min-height: 80px; }
        .has-meetings::after { content: '‚Ä¢'; color: #3B82F6; font-size: 24px; position: absolute; top: 4px; right: 8px; }
        .loading { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
    <!-- Toast Notification -->
    <div id="toast" class="toast bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg hidden">
        <span id="toast-message"></span>
    </div>

    <!-- Main Container -->
    <div id="app" class="max-w-md mx-auto bg-white min-h-screen">
        
        <!-- Daily View -->
        <div id="daily-view" class="view">
            <!-- Header -->
            <div class="bg-blue-600 text-white p-4">
                <div class="flex items-center justify-between mb-4">
                    <button id="prev-day" class="nav-btn bg-blue-500 hover:bg-blue-400 rounded-lg flex items-center justify-center">
                        <span>&lt;</span>
                    </button>
                    <div id="current-date" class="date-display text-center flex-1 mx-4"></div>
                    <button id="next-day" class="nav-btn bg-blue-500 hover:bg-blue-400 rounded-lg flex items-center justify-center">
                        <span>&gt;</span>
                    </button>
                </div>
                <button id="week-view-btn" class="btn-action w-full bg-blue-500 hover:bg-blue-400 rounded-lg font-semibold">
                    üìÖ Week View
                </button>
            </div>

            <!-- Meeting List -->
            <div id="meetings-container" class="p-4 space-y-4">
                <div id="loading-daily" class="text-center py-8">
                    <div class="text-lg">Loading meetings...</div>
                </div>
                <div id="no-meetings" class="text-center py-8 hidden">
                    <div class="text-lg text-gray-600">No meetings scheduled for this day</div>
                </div>
            </div>
        </div>

        <!-- Weekly View -->
        <div id="weekly-view" class="view hidden">
            <!-- Header -->
            <div class="bg-blue-600 text-white p-4">
                <div class="flex items-center justify-between mb-4">
                    <button id="prev-week" class="nav-btn bg-blue-500 hover:bg-blue-400 rounded-lg flex items-center justify-center">
                        <span>&lt;</span>
                    </button>
                    <div id="week-range" class="date-display text-center flex-1 mx-4"></div>
                    <button id="next-week" class="nav-btn bg-blue-500 hover:bg-blue-400 rounded-lg flex items-center justify-center">
                        <span>&gt;</span>
                    </button>
                </div>
                <button id="daily-view-btn" class="btn-action w-full bg-blue-500 hover:bg-blue-400 rounded-lg font-semibold">
                    üìã Daily View
                </button>
            </div>

            <!-- Calendar Grid -->
            <div id="calendar-grid" class="p-4">
                <div class="grid grid-cols-7 gap-1 mb-2">
                    <div class="text-center font-semibold text-sm py-2">Sun</div>
                    <div class="text-center font-semibold text-sm py-2">Mon</div>
                    <div class="text-center font-semibold text-sm py-2">Tue</div>
                    <div class="text-center font-semibold text-sm py-2">Wed</div>
                    <div class="text-center font-semibold text-sm py-2">Thu</div>
                    <div class="text-center font-semibold text-sm py-2">Fri</div>
                    <div class="text-center font-semibold text-sm py-2">Sat</div>
                </div>
                <div id="calendar-days" class="grid grid-cols-7 gap-1">
                    <!-- Calendar days will be populated here -->
                </div>
            </div>
        </div>

        <!-- Details View -->
        <div id="details-view" class="view hidden">
            <!-- Header -->
            <div class="bg-blue-600 text-white p-4">
                <div class="flex items-center justify-between">
                    <button id="back-to-daily" class="nav-btn bg-blue-500 hover:bg-blue-400 rounded-lg flex items-center justify-center">
                        <span>&lt;</span>
                    </button>
                    <div class="date-display text-center flex-1 mx-4">Meeting Details</div>
                    <div class="nav-btn"></div> <!-- Spacer -->
                </div>
            </div>

            <!-- Meeting Details -->
            <div id="meeting-details" class="p-4 space-y-6">
                <!-- Details will be populated here -->
            </div>

            <!-- ICS Upload -->
            <div class="p-4 border-t">
                <input type="file" id="ics-upload" accept=".ics" class="hidden">
                <button id="upload-ics-btn" class="btn-large w-full bg-green-600 hover:bg-green-500 text-white rounded-lg font-semibold">
                    üìÅ Upload Invite (.ics)
                </button>
            </div>
        </div>

        <!-- Edit Modal -->
        <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4" style="z-index: 1000;">
            <div class="bg-white rounded-lg w-full max-w-sm">
                <div class="p-6">
                    <h3 id="modal-title" class="text-xl font-semibold mb-4">Edit Field</h3>
                    <div id="modal-content">
                        <!-- Modal content will be populated here -->
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button id="modal-cancel" class="btn-action flex-1 bg-gray-300 hover:bg-gray-200 rounded-lg font-semibold">
                            Cancel
                        </button>
                        <button id="modal-save" class="btn-action flex-1 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-semibold">
                            Save
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Users need to add their API credentials here
        const CONFIG = {
            API_KEY: 'YOUR_GOOGLE_API_KEY_HERE',
            CLIENT_ID: 'YOUR_GOOGLE_CLIENT_ID_HERE',
            SPREADSHEET_ID: '1sowU3Z15kfO2kpC-hgEyzoCtBekkFb38',
            RANGE: 'Sheet1!A:Z'
        };

        // Global state
        let currentDate = new Date();
        let currentWeekStart = new Date();
        let meetingsData = [];
        let currentMeeting = null;
        let isAuthenticated = false;
        let gapiLoaded = false;

        // Handle Google API load
        function handleGoogleAPILoad() {
            gapiLoaded = true;
            if (document.readyState === 'complete') {
                loadGoogleAPI();
            }
        }

        // Initialize the application
        function init() {
            setupEventListeners();
            updateDateDisplay();
            setWeekStart();
            
            // Load Google API if it's ready
            if (gapiLoaded) {
                loadGoogleAPI();
            }
        }

        // Load Google API
        function loadGoogleAPI() {
            if (typeof gapi === 'undefined') {
                console.error('Google API not loaded');
                showToast('Google API failed to load', 'error');
                return;
            }
            gapi.load('client:auth2', initializeGapi);
        }

        // Initialize Google API
        function initializeGapi() {
            if (!CONFIG.API_KEY || CONFIG.API_KEY === 'YOUR_GOOGLE_API_KEY_HERE') {
                showToast('Please configure your Google API credentials', 'error');
                return;
            }

            gapi.client.init({
                apiKey: CONFIG.API_KEY,
                clientId: CONFIG.CLIENT_ID,
                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                scope: 'https://www.googleapis.com/auth/spreadsheets'
            }).then(() => {
                const authInstance = gapi.auth2.getAuthInstance();
                if (authInstance.isSignedIn.get()) {
                    isAuthenticated = true;
                    loadMeetings();
                } else {
                    authInstance.signIn().then(() => {
                        isAuthenticated = true;
                        loadMeetings();
                    });
                }
            }).catch(error => {
                console.error('Error initializing Google API:', error);
                showToast('Failed to connect to Google Sheets', 'error');
            });
        }

        // Load meetings from Google Sheet
        function loadMeetings() {
            if (!isAuthenticated) return;

            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: CONFIG.SPREADSHEET_ID,
                range: CONFIG.RANGE,
            }).then(response => {
                const values = response.result.values;
                if (values && values.length > 1) {
                    meetingsData = parseSheetData(values);
                    displayMeetings();
                    updateCalendar();
                }
                document.getElementById('loading-daily').style.display = 'none';
            }).catch(error => {
                console.error('Error loading meetings:', error);
                showToast('Failed to load meetings', 'error');
                document.getElementById('loading-daily').style.display = 'none';
            });
        }

        // Parse sheet data into meeting objects
        function parseSheetData(values) {
            const headers = values[0];
            const meetings = [];

            for (let i = 1; i < values.length; i++) {
                const row = values[i];
                const meeting = {};
                
                headers.forEach((header, index) => {
                    meeting[header] = row[index] || '';
                });

                if (meeting['Bid Open Date']) {
                    meetings.push({
                        ...meeting,
                        rowIndex: i + 1
                    });
                }
            }

            return meetings;
        }

        // Display meetings for current date
        function displayMeetings() {
            const container = document.getElementById('meetings-container');
            const loadingDiv = document.getElementById('loading-daily');
            const noMeetingsDiv = document.getElementById('no-meetings');
            
            // Clear existing meetings
            const existingCards = container.querySelectorAll('.meeting-card');
            existingCards.forEach(card => card.remove());

            const dateStr = formatDateForComparison(currentDate);
            const todaysMeetings = meetingsData.filter(meeting => {
                const meetingDate = parseDate(meeting['Bid Open Date']);
                return meetingDate && formatDateForComparison(meetingDate) === dateStr;
            });

            if (todaysMeetings.length === 0) {
                noMeetingsDiv.classList.remove('hidden');
                return;
            }

            noMeetingsDiv.classList.add('hidden');

            todaysMeetings.forEach(meeting => {
                const card = createMeetingCard(meeting);
                container.appendChild(card);
            });
        }

        // Create a meeting card element
        function createMeetingCard(meeting) {
            const card = document.createElement('div');
            card.className = 'meeting-card card bg-white border border-gray-200 rounded-lg p-4 space-y-4';

            const time = meeting['Bid Open Time'] || 'Time TBD';
            const city = meeting['Bid Open City'] || 'Location TBD';
            const street = meeting['Bid Open Street'] || '';
            const state = meeting['Bid Open State'] || '';
            const zip = meeting['Bid Open Zip'] || '';

            card.innerHTML = `
                <div class="text-center">
                    <div class="meeting-time text-blue-600">${time}</div>
                    <div class="meeting-city text-gray-800">${city}</div>
                </div>

                <div class="space-y-3">
                    <button class="location-btn btn-action w-full bg-green-600 hover:bg-green-500 text-white rounded-lg font-semibold flex items-center justify-center gap-2">
                        üìç Go to ${street || city}
                    </button>
                    
                    <button class="project-btn btn-action w-full bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-semibold flex items-center justify-center gap-2">
                        üîó Open Project Link
                    </button>
                    
                    <button class="details-btn btn-action w-full bg-purple-600 hover:bg-purple-500 text-white rounded-lg font-semibold flex items-center justify-center gap-2">
                        ‚ÑπÔ∏è View/Edit Details
                    </button>
                </div>
            `;

            // Add event listeners
            setupMeetingCardListeners(card, meeting);

            return card;
        }

        // Setup event listeners for meeting card buttons
        function setupMeetingCardListeners(card, meeting) {
            const locationBtn = card.querySelector('.location-btn');
            const projectBtn = card.querySelector('.project-btn');
            const detailsBtn = card.querySelector('.details-btn');

            // Location button
            locationBtn.addEventListener('click', () => {
                const address = buildFullAddress(meeting);
                const encodedAddress = encodeURIComponent(address);
                window.open(`https://maps.apple.com/?q=${encodedAddress}`, '_blank');
            });

            locationBtn.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                openAddressEditModal(meeting);
            });

            // Long press for mobile
            let longPressTimer;
            locationBtn.addEventListener('touchstart', (e) => {
                longPressTimer = setTimeout(() => {
                    e.preventDefault();
                    openAddressEditModal(meeting);
                }, 500);
            });
            locationBtn.addEventListener('touchend', () => {
                clearTimeout(longPressTimer);
            });

            // Project button
            projectBtn.addEventListener('click', () => {
                const bidSourceId = meeting['BID Source ID'];
                if (bidSourceId) {
                    const url = `https://app.constructconnect.com/project/${bidSourceId}/p?sourceType=3`;
                    window.open(url, '_blank');
                } else {
                    showToast('No project ID available', 'error');
                }
            });

            projectBtn.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                copyProjectLink(meeting);
            });

            // Long press for mobile
            projectBtn.addEventListener('touchstart', (e) => {
                longPressTimer = setTimeout(() => {
                    e.preventDefault();
                    copyProjectLink(meeting);
                }, 500);
            });
            projectBtn.addEventListener('touchend', () => {
                clearTimeout(longPressTimer);
            });

            // Details button
            detailsBtn.addEventListener('click', () => {
                showMeetingDetails(meeting);
            });
        }

        // Build full address string
        function buildFullAddress(meeting) {
            const parts = [
                meeting['Bid Open Street'],
                meeting['Bid Open City'],
                meeting['Bid Open State'],
                meeting['Bid Open Zip']
            ].filter(part => part && part.trim());
            
            return parts.join(', ');
        }

        // Copy project link
        function copyProjectLink(meeting) {
            const bidSourceId = meeting['BID Source ID'];
            if (bidSourceId) {
                const url = `https://app.constructconnect.com/project/${bidSourceId}/p?sourceType=3`;
                navigator.clipboard.writeText(url).then(() => {
                    showToast('Link copied!');
                });
            }
        }

        // Open address edit modal
        function openAddressEditModal(meeting) {
            const modal = document.getElementById('edit-modal');
            const title = document.getElementById('modal-title');
            const content = document.getElementById('modal-content');

            title.textContent = 'Edit Address';
            content.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="field-label block mb-2">Street:</label>
                        <input type="text" id="edit-street" class="w-full p-3 border border-gray-300 rounded-lg text-lg" value="${meeting['Bid Open Street'] || ''}">
                    </div>
                    <div>
                        <label class="field-label block mb-2">City:</label>
                        <input type="text" id="edit-city" class="w-full p-3 border border-gray-300 rounded-lg text-lg" value="${meeting['Bid Open City'] || ''}">
                    </div>
                    <div>
                        <label class="field-label block mb-2">State:</label>
                        <input type="text" id="edit-state" class="w-full p-3 border border-gray-300 rounded-lg text-lg" value="${meeting['Bid Open State'] || ''}">
                    </div>
                    <div>
                        <label class="field-label block mb-2">Zip:</label>
                        <input type="text" id="edit-zip" class="w-full p-3 border border-gray-300 rounded-lg text-lg" value="${meeting['Bid Open Zip'] || ''}">
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');
            modal.classList.add('flex');

            const saveBtn = document.getElementById('modal-save');
            saveBtn.onclick = () => {
                const newStreet = document.getElementById('edit-street').value;
                const newCity = document.getElementById('edit-city').value;
                const newState = document.getElementById('edit-state').value;
                const newZip = document.getElementById('edit-zip').value;

                updateMeetingField(meeting, 'Bid Open Street', newStreet);
                updateMeetingField(meeting, 'Bid Open City', newCity);
                updateMeetingField(meeting, 'Bid Open State', newState);
                updateMeetingField(meeting, 'Bid Open Zip', newZip);

                closeModal();
                displayMeetings();
            };
        }

        // Show meeting details view
        function showMeetingDetails(meeting) {
            currentMeeting = meeting;
            const detailsContainer = document.getElementById('meeting-details');
            
            detailsContainer.innerHTML = '';

            const fields = [
                { label: 'Project Name', key: 'Project Name' },
                { label: 'Date', key: 'Bid Open Date' },
                { label: 'Time', key: 'Bid Open Time' },
                { label: 'Street', key: 'Bid Open Street' },
                { label: 'City', key: 'Bid Open City' },
                { label: 'State', key: 'Bid Open State' },
                { label: 'Zip', key: 'Bid Open Zip' },
                { label: 'Project Description', key: 'Project Description' },
                { label: 'Bid Project Info', key: 'Bid Project Info' },
                { label: 'BID Source ID', key: 'BID Source ID' },
                { label: 'Low Bid Contractor', key: 'Low Bid Contractor' },
                { label: 'Low Bid Amount', key: 'Low Bid Amount' },
                { label: 'Low Bid Contractor 2', key: 'Low Bid Contractor 2' },
                { label: 'Low Bid Amount 2', key: 'Low Bid Amount 2' },
                { label: 'Low Bid Contractor 3', key: 'Low Bid Contractor 3' },
                { label: 'Low Bid Amount 3', key: 'Low Bid Amount 3' }
            ];

            fields.forEach(field => {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'border-b border-gray-200 pb-4';
                
                fieldDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <label class="field-label text-gray-600">${field.label}:</label>
                        <button class="edit-field-btn text-blue-600 text-sm font-semibold px-3 py-1 rounded hover:bg-blue-50" data-field="${field.key}">
                            Edit
                        </button>
                    </div>
                    <div class="field-value text-gray-900">${meeting[field.key] || 'Not set'}</div>
                `;

                detailsContainer.appendChild(fieldDiv);
            });

            // Add edit listeners
            detailsContainer.querySelectorAll('.edit-field-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const fieldKey = btn.dataset.field;
                    openFieldEditModal(meeting, fieldKey);
                });
            });

            switchToView('details-view');
        }

        // Open field edit modal
        function openFieldEditModal(meeting, fieldKey) {
            const modal = document.getElementById('edit-modal');
            const title = document.getElementById('modal-title');
            const content = document.getElementById('modal-content');

            const fieldLabel = fieldKey.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
            title.textContent = `Edit ${fieldLabel}`;
            
            const currentValue = meeting[fieldKey] || '';
            content.innerHTML = `
                <div>
                    <label class="field-label block mb-2">${fieldLabel}:</label>
                    <textarea id="edit-field-value" class="w-full p-3 border border-gray-300 rounded-lg text-lg" rows="3">${currentValue}</textarea>
                </div>
            `;

            modal.classList.remove('hidden');
            modal.classList.add('flex');

            const saveBtn = document.getElementById('modal-save');
            saveBtn.onclick = () => {
                const newValue = document.getElementById('edit-field-value').value;
                updateMeetingField(meeting, fieldKey, newValue);
                closeModal();
                showMeetingDetails(meeting); // Refresh details view
            };
        }

        // Update meeting field in Google Sheet
        function updateMeetingField(meeting, fieldKey, newValue) {
            if (!isAuthenticated) return;

            // Find column index for the field
            const headers = ['Bid Open Date', 'Bid Open Time', 'Bid Open Street', 'Bid Open City', 'Bid Open State', 'Bid Open Zip', 'BID Source ID', 'Project Name', 'Project Description', 'Bid Project Info', 'Low Bid Contractor', 'Low Bid Amount', 'Low Bid Contractor 2', 'Low Bid Amount 2', 'Low Bid Contractor 3', 'Low Bid Amount 3'];
            const columnIndex = headers.indexOf(fieldKey);
            
            if (columnIndex === -1) return;

            const columnLetter = String.fromCharCode(65 + columnIndex); // A, B, C, etc.
            const cellRange = `${columnLetter}${meeting.rowIndex}`;

            gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: CONFIG.SPREADSHEET_ID,
                range: cellRange,
                valueInputOption: 'RAW',
                resource: {
                    values: [[newValue]]
                }
            }).then(() => {
                meeting[fieldKey] = newValue;
                showToast('Updated successfully!');
            }).catch(error => {
                console.error('Error updating field:', error);
                showToast('Failed to update', 'error');
            });
        }

        // Handle ICS file upload
        function handleICSUpload(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const icsData = e.target.result;
                    const parsed = ICAL.parse(icsData);
                    const vcalendar = new ICAL.Component(parsed);
                    const vevent = vcalendar.getFirstSubcomponent('vevent');

                    if (vevent) {
                        const summary = vevent.getFirstPropertyValue('summary') || '';
                        const location = vevent.getFirstPropertyValue('location') || '';
                        const description = vevent.getFirstPropertyValue('description') || '';
                        const dtstart = vevent.getFirstPropertyValue('dtstart');

                        // Parse project ID from summary
                        const projectIdMatch = summary.match(/\(Project ID (\d+)\)/);
                        const bidSourceId = projectIdMatch ? projectIdMatch[1] : '';

                        // Parse location into components
                        const locationParts = location.split(',').map(part => part.trim());
                        const street = locationParts[0] || '';
                        const city = locationParts[1] || '';
                        const stateZip = locationParts[2] || '';
                        const stateZipMatch = stateZip.match(/^(.+?)\s+(\d+)$/);
                        const state = stateZipMatch ? stateZipMatch[1] : stateZip;
                        const zip = stateZipMatch ? stateZipMatch[2] : '';

                        // Format date and time
                        const date = dtstart ? dtstart.toJSDate() : new Date();
                        const dateStr = date.toLocaleDateString();
                        const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                        // Create new meeting object
                        const newMeeting = {
                            'Bid Open Date': dateStr,
                            'Bid Open Time': timeStr,
                            'Bid Open Street': street,
                            'Bid Open City': city,
                            'Bid Open State': state,
                            'Bid Open Zip': zip,
                            'BID Source ID': bidSourceId,
                            'Project Name': summary.replace(/\s*\(Project ID \d+\)/, ''),
                            'Project Description': '',
                            'Bid Project Info': description,
                            'Low Bid Contractor': '',
                            'Low Bid Amount': '',
                            'Low Bid Contractor 2': '',
                            'Low Bid Amount 2': '',
                            'Low Bid Contractor 3': '',
                            'Low Bid Amount 3': ''
                        };

                        // Show populated form for confirmation
                        showNewMeetingForm(newMeeting);
                    }
                } catch (error) {
                    console.error('Error parsing ICS file:', error);
                    showToast('Failed to parse ICS file', 'error');
                }
            };
            reader.readAsText(file);
        }

        // Show new meeting form
        function showNewMeetingForm(meeting) {
            // For now, just save directly - in a full implementation, you'd show a confirmation form
            saveMeetingToSheet(meeting);
        }

        // Save meeting to sheet
        function saveMeetingToSheet(meeting) {
            if (!isAuthenticated) return;

            const values = [
                meeting['Bid Open Date'],
                meeting['Bid Open Time'],
                meeting['Bid Open Street'],
                meeting['Bid Open City'],
                meeting['Bid Open State'],
                meeting['Bid Open Zip'],
                meeting['BID Source ID'],
                meeting['Project Name'],
                meeting['Project Description'],
                meeting['Bid Project Info'],
                meeting['Low Bid Contractor'],
                meeting['Low Bid Amount'],
                meeting['Low Bid Contractor 2'],
                meeting['Low Bid Amount 2'],
                meeting['Low Bid Contractor 3'],
                meeting['Low Bid Amount 3']
            ];

            gapi.client.sheets.spreadsheets.values.append({
                spreadsheetId: CONFIG.SPREADSHEET_ID,
                range: 'A:P',
                valueInputOption: 'RAW',
                resource: {
                    values: [values]
                }
            }).then(() => {
                showToast('Meeting saved successfully!');
                loadMeetings(); // Refresh data
            }).catch(error => {
                console.error('Error saving meeting:', error);
                showToast('Failed to save meeting', 'error');
            });
        }

        // Calendar functions
        function updateCalendar() {
            const calendarDays = document.getElementById('calendar-days');
            calendarDays.innerHTML = '';

            const weekStart = new Date(currentWeekStart);
            
            for (let i = 0; i < 7; i++) {
                const day = new Date(weekStart);
                day.setDate(weekStart.getDate() + i);
                
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day border border-gray-200 rounded p-2 text-center cursor-pointer hover:bg-blue-50 relative';
                
                if (isSameDay(day, new Date())) {
                    dayDiv.classList.add('bg-blue-100', 'border-blue-400');
                }

                const hasMeetings = meetingsData.some(meeting => {
                    const meetingDate = parseDate(meeting['Bid Open Date']);
                    return meetingDate && isSameDay(meetingDate, day);
                });

                if (hasMeetings) {
                    dayDiv.classList.add('has-meetings');
                }

                dayDiv.innerHTML = `<div class="font-semibold">${day.getDate()}</div>`;
                
                dayDiv.addEventListener('click', () => {
                    currentDate = new Date(day);
                    updateDateDisplay();
                    displayMeetings();
                    switchToView('daily-view');
                });

                calendarDays.appendChild(dayDiv);
            }

            updateWeekRange();
        }

        function setWeekStart() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() - dayOfWeek);
        }

        function updateWeekRange() {
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(currentWeekStart.getDate() + 6);
            
            const startStr = formatDate(currentWeekStart);
            const endStr = formatDate(weekEnd);
            
            document.getElementById('week-range').textContent = `${startStr} - ${endStr}`;
        }

        // Utility functions
        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            // Try different date formats
            const formats = [
                /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/, // MM/DD/YYYY
                /^(\d{4})-(\d{1,2})-(\d{1,2})$/, // YYYY-MM-DD
                /^(\d{1,2})-(\d{1,2})-(\d{4})$/ // DD-MM-YYYY
            ];

            for (const format of formats) {
                const match = dateStr.match(format);
                if (match) {
                    if (format === formats[0]) { // MM/DD/YYYY
                        return new Date(match[3], match[1] - 1, match[2]);
                    } else if (format === formats[1]) { // YYYY-MM-DD
                        return new Date(match[1], match[2] - 1, match[3]);
                    } else if (format === formats[2]) { // DD-MM-YYYY
                        return new Date(match[3], match[2] - 1, match[1]);
                    }
                }
            }

            // Fallback to Date constructor
            const date = new Date(dateStr);
            return isNaN(date.getTime()) ? null : date;
        }

        function formatDate(date) {
            const options = { month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        function formatDateForComparison(date) {
            return date.toISOString().split('T')[0];
        }

        function isSameDay(date1, date2) {
            return formatDateForComparison(date1) === formatDateForComparison(date2);
        }

        function getRelativeDateString(date) {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);

            if (isSameDay(date, today)) {
                return 'Today';
            } else if (isSameDay(date, tomorrow)) {
                return 'Tomorrow';
            } else if (isSameDay(date, yesterday)) {
                return 'Yesterday';
            } else {
                const options = { weekday: 'long', month: 'long', day: 'numeric' };
                return date.toLocaleDateString('en-US', options);
            }
        }

        function updateDateDisplay() {
            const dateDisplay = document.getElementById('current-date');
            const relativeDate = getRelativeDateString(currentDate);
            const formattedDate = currentDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
            
            if (relativeDate.includes('day')) {
                dateDisplay.textContent = `${relativeDate}, ${formattedDate.split(' ')[0]} ${formattedDate.split(' ')[1]}`;
            } else {
                dateDisplay.textContent = relativeDate;
            }
        }

        function switchToView(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            
            if (type === 'error') {
                toast.className = 'toast bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg';
            } else {
                toast.className = 'toast bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg';
            }
            
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function closeModal() {
            const modal = document.getElementById('edit-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Event listeners setup
        function setupEventListeners() {
            // Navigation buttons
            document.getElementById('prev-day').addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() - 1);
                updateDateDisplay();
                displayMeetings();
            });

            document.getElementById('next-day').addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() + 1);
                updateDateDisplay();
                displayMeetings();
            });

            document.getElementById('week-view-btn').addEventListener('click', () => {
                switchToView('weekly-view');
            });

            document.getElementById('daily-view-btn').addEventListener('click', () => {
                switchToView('daily-view');
            });

            document.getElementById('back-to-daily').addEventListener('click', () => {
                switchToView('daily-view');
            });

            // Week navigation
            document.getElementById('prev-week').addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                updateCalendar();
            });

            document.getElementById('next-week').addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                updateCalendar();
            });

            // Modal controls
            document.getElementById('modal-cancel').addEventListener('click', closeModal);

            // ICS upload
            document.getElementById('upload-ics-btn').addEventListener('click', () => {
                document.getElementById('ics-upload').click();
            });

            document.getElementById('ics-upload').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file && file.name.endsWith('.ics')) {
                    handleICSUpload(file);
                } else {
                    showToast('Please select a valid .ics file', 'error');
                }
            });

            // Close modal when clicking outside
            document.getElementById('edit-modal').addEventListener('click', (e) => {
                if (e.target.id === 'edit-modal') {
                    closeModal();
                }
            });

            // Touch/swipe support for weekly view
            let touchStartX = 0;
            let touchEndX = 0;

            document.getElementById('weekly-view').addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            });

            document.getElementById('weekly-view').addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });

            function handleSwipe() {
                const swipeThreshold = 50;
                const diff = touchStartX - touchEndX;

                if (Math.abs(diff) > swipeThreshold) {
                    if (diff > 0) {
                        // Swipe left - next week
                        currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                        updateCalendar();
                    } else {
                        // Swipe right - previous week
                        currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                        updateCalendar();
                    }
                }
            }
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            init();
            // Also try to load Google API if it's already available
            if (gapiLoaded && typeof gapi !== 'undefined') {
                loadGoogleAPI();
            }
        });
    </script>
</body>
</html>
