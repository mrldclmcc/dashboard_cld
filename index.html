<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMCC Dashboard App</title>
    <style>
        /* ... (your existing CSS, unchanged) ... */
        /* For brevity, CSS not shown but remains unchanged. */
    </style>
</head>
<body>
    <div class="header">
        LMCC Dashboard App<br>
        <span style="font-size: 14px; color: #eac8a6;">
            All times shown in: <span id="userTimeZone"></span>
        </span>
    </div>

    <div class="container">
        <!-- ... (rest of your HTML unchanged) ... -->
        <div class="date-nav">
            <button onclick="changeDate(-1)">‚Äπ Prev</button>
            <div class="current-date" id="currentDate">Today</div>
            <button onclick="changeDate(1)">Next ‚Ä∫</button>
        </div>

        <div class="search-container" id="searchContainer" style="display: none;">
            <input type="text" class="search-input" id="searchInput" placeholder="Search meetings..." 
                   oninput="searchMeetings(this.value)">
        </div>

        <div class="week-view" id="weekView">
            <div class="week-nav">
                <button onclick="changeWeek(-1)">‚Äπ Prev Week</button>
                <div id="weekTitle">Week View</div>
                <button onclick="changeWeek(1)">Next Week ‚Ä∫</button>
            </div>
            <div class="week-days" id="weekDays"></div>
        </div>

        <div id="meetingsContainer">
            <div class="loading">Loading meetings...</div>
        </div>
    </div>

    <button class="fab add-fab" onclick="showAddMeetingModal()">+</button>
    <button class="fab search-fab" onclick="toggleSearch()">üîç</button>
    <!-- ... (modals and forms unchanged) ... -->

    <div class="modal" id="addMeetingModal">
        <!-- ... (unchanged) ... -->
    </div>
    <div class="modal" id="meetingDetailsModal">
        <!-- ... (unchanged) ... -->
    </div>
    <div class="modal" id="editMeetingModal">
        <!-- ... (unchanged) ... -->
    </div>

    <script>
        // Global variables
        let allMeetings = [];
        let filteredMeetings = [];
        let currentDate = new Date();
        let currentWeekStart = new Date();
        let isSearchMode = false;
        let uploadedFileData = null;

        // Detect user's local time zone
        const userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;

        const API_URL = 'https://script.google.com/macros/s/AKfycbwLO9Z7IEWbSNn0t87MUoSrEibjC8CtLiZ6xlHfEuPL1zoN07emOeZ8_KuWeoKrM9Se/exec';

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('userTimeZone').textContent = userTimeZone;
            loadMeetings();
            updateDateDisplay();
            setupWeekView();
        });

        // Load meetings from Google Sheets
        async function loadMeetings() {
            try {
                const response = await fetch(`${API_URL}?action=getMeetings`);
                const data = await response.json();
                console.log('Raw API response:', data);
                
                // Filter out meetings with missing required fields
                allMeetings = data.filter(meeting => {
                    return meeting['Bid Open Date'] && meeting['Bid Open Time'] && meeting['Project Name'];
                }).map(meeting => {
                    // Ensure consistent field names
                    return {
                        ...meeting,
                        'Project Description': meeting['Project Description'] || ''
                    };
                });
                
                filteredMeetings = [...allMeetings];
                displayMeetings();
            } catch (error) {
                console.error('Error loading meetings:', error);
                document.getElementById('meetingsContainer').innerHTML = 
                    '<div class="no-meetings">Error loading meetings. Please try again.</div>';
            }
        }

        // Display meetings for current date
        function displayMeetings() {
            const container = document.getElementById('meetingsContainer');
            const currentDateStr = formatDateForComparison(currentDate);
            
            let meetingsToShow = isSearchMode ? filteredMeetings : 
                filteredMeetings.filter(meeting => {
                    const meetingDate = new Date(meeting['Bid Open Date']);
                    return formatDateForComparison(meetingDate) === currentDateStr;
                });

            if (meetingsToShow.length === 0) {
                container.innerHTML = `<div class="no-meetings">
                    ${isSearchMode ? 'No meetings found' : 'No meetings scheduled for this date'}
                </div>`;
                return;
            }

            // Sort meetings by time
            meetingsToShow.sort((a, b) => {
                const timeA = convertTimeToMinutes(a['Bid Open Time']);
                const timeB = convertTimeToMinutes(b['Bid Open Time']);
                return timeA - timeB;
            });

            container.innerHTML = meetingsToShow.map(meeting => createMeetingCard(meeting)).join('');
        }

        // Create meeting card HTML
        function createMeetingCard(meeting) {
            const meetingDate = new Date(meeting['Bid Open Date']);
            const dateDisplay = getDateDisplay(meetingDate);
            
            // Format time in user's time zone
            const time = formatMeetingTime(meeting['Bid Open Time']);
            const city = meeting['Bid Open City'] || 'Location TBD';
            const state = meeting['Bid Open State'] || '';
            const location = city + (state ? `, ${state}` : '');
            
            const fullAddress = [
                meeting['Bid Open Street'],
                meeting['Bid Open City'],
                meeting['Bid Open State'],
                meeting['Bid Open Zip']
            ].filter(Boolean).join(', ');

            const projectUrl = meeting['BID Source ID'] ? 
                `https://app.constructconnect.com/project/${meeting['BID Source ID']}/p?sourceType=3` : '#';

            return `
                <div class="meeting-card">
                    <div class="meeting-header">
                        <div class="meeting-title">${meeting['Project Name'] || 'Untitled Project'}</div>
                        <div class="meeting-time">${dateDisplay} ‚Ä¢ ${time} ‚Ä¢ ${location}</div>
                    </div>
                    <div class="meeting-body">
                        <button class="action-button maps-button" 
                                onclick="openMaps('${fullAddress}')" 
                                oncontextmenu="editAddress('${meeting['BID Source ID']}', '${fullAddress}'); return false;">
                            üìç Open in Maps
                        </button>
                        <button class="action-button url-button" 
                                onclick="openUrl('${projectUrl}')" 
                                oncontextmenu="copyUrl('${projectUrl}'); return false;">
                            üîó View Project
                        </button>
                        <button class="action-button details-button" 
                                onclick="showMeetingDetails('${meeting['BID Source ID']}')">
                            üìã View Details
                        </button>
                    </div>
                </div>
            `;
        }

        // Format the datetime string to readable time in user's time zone
        function formatMeetingTime(timeString) {
            if (!timeString) return 'Time TBD';
            try {
                const date = new Date(timeString);
                if (isNaN(date.getTime())) return 'Time TBD';
                return date.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true,
                    timeZone: userTimeZone
                });
            } catch (error) {
                console.error('Error parsing time:', timeString, error);
                return 'Time TBD';
            }
        }

        // Extract time portion from datetime for form input
        function extractTimeFromDateTime(timeString) {
            if (!timeString) return '';
            try {
                const date = new Date(timeString);
                if (isNaN(date.getTime())) return '';
                // Format as HH:MM for time input
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${hours}:${minutes}`;
            } catch (error) {
                console.error('Error extracting time:', timeString, error);
                return '';
            }
        }

        // Utility functions
        function formatDateForComparison(date) {
            // Compare using user's local date
            return date.toLocaleDateString('en-CA', { timeZone: userTimeZone });
        }

        function getDateDisplay(date) {
            const today = new Date();
            const todayUser = new Date(today.toLocaleString('en-US', { timeZone: userTimeZone }));
            const dateUser = new Date(date.toLocaleString('en-US', { timeZone: userTimeZone }));

            const tomorrow = new Date(todayUser);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const yesterday = new Date(todayUser);
            yesterday.setDate(yesterday.getDate() - 1);

            if (formatDateForComparison(dateUser) === formatDateForComparison(todayUser)) {
                return 'Today';
            } else if (formatDateForComparison(dateUser) === formatDateForComparison(tomorrow)) {
                return 'Tomorrow';
            } else if (formatDateForComparison(dateUser) === formatDateForComparison(yesterday)) {
                return 'Yesterday';
            } else {
                return dateUser.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric'
                });
            }
        }

        function convertTimeToMinutes(timeString) {
            if (!timeString) return 0;
            try {
                const date = new Date(timeString);
                if (isNaN(date.getTime())) return 0;
                // Get time in user's time zone
                const userHours = date.toLocaleString('en-US', { 
                    hour: 'numeric', 
                    hour12: false,
                    timeZone: userTimeZone
                });
                const userMinutes = date.toLocaleString('en-US', { 
                    minute: 'numeric',
                    timeZone: userTimeZone
                });
                return parseInt(userHours) * 60 + parseInt(userMinutes);
            } catch (error) {
                console.error('Error parsing time for sorting:', timeString, error);
                return 0;
            }
        }

        // Navigation functions
        function changeDate(days) {
            currentDate.setDate(currentDate.getDate() + days);
            updateDateDisplay();
            displayMeetings();
        }

        function updateDateDisplay() {
            document.getElementById('currentDate').textContent = getDateDisplay(currentDate);
        }

        // Action button functions
        function openMaps(address) {
            if (address && address !== 'undefined') {
                const encodedAddress = encodeURIComponent(address);
                const mapsUrl = `https://maps.google.com/?q=${encodedAddress}`;
                window.open(mapsUrl, '_blank');
            }
        }

        function openUrl(url) {
            if (url && url !== '#') {
                window.open(url, '_blank');
            }
        }

        function copyUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                alert('URL copied to clipboard!');
            });
        }

        function editAddress(bidSourceId, currentAddress) {
            const newAddress = prompt('Enter new address:', currentAddress);
            if (newAddress && newAddress !== currentAddress) {
                updateMeetingAddress(bidSourceId, newAddress);
            }
        }

        // Meeting details
        function showMeetingDetails(bidSourceId) {
            const meeting = allMeetings.find(m => String(m['BID Source ID']) === String(bidSourceId));
            if (!meeting) {
                console.error('Meeting not found for ID:', bidSourceId);
                alert('Meeting details not found');
                return;
            }

            const modal = document.getElementById('meetingDetailsModal');
            const content = document.getElementById('meetingDetailsContent');
            
            content.innerHTML = `
                <div style="line-height: 1.6;">
                    <h3 style="color: #3D74B6; margin-bottom: 15px;">${meeting['Project Name'] || 'Untitled Project'}</h3>
                    <p><strong>Date:</strong> ${new Date(meeting['Bid Open Date']).toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        timeZone: userTimeZone
                    })}</p>
                    <p><strong>Time:</strong> ${formatMeetingTime(meeting['Bid Open Time'])} (${userTimeZone})</p>
                    <p><strong>Location:</strong> ${[meeting['Bid Open Street'], meeting['Bid Open City'], meeting['Bid Open State'], meeting['Bid Open Zip']].filter(Boolean).join(', ')}</p>
                    <p><strong>Description:</strong> ${meeting['Project Description'] || 'No description available'}</p>
                    <p><strong>Bid Info:</strong> ${meeting['Bid Project Info'] || 'No additional info'}</p>
                    ${meeting['Low Bid Contractor'] ? `<p><strong>Low Bidder:</strong> ${meeting['Low Bid Contractor']} - $${meeting['Low Bid Amount'] || 'TBD'}</p>` : ''}
                    ${meeting['Low Bid Contractor 2'] ? `<p><strong>2nd Low Bidder:</strong> ${meeting['Low Bid Contractor 2']} - $${meeting['Low Bid Amount 2'] || 'TBD'}</p>` : ''}
                    ${meeting['Low Bid Contractor 3'] ? `<p><strong>3rd Low Bidder:</strong> ${meeting['Low Bid Contractor 3']} - $${meeting['Low Bid Amount 3'] || 'TBD'}</p>` : ''}
                    <button class="submit-button" onclick="editMeeting('${bidSourceId}')" style="margin-top: 20px;">
                        Edit Meeting
                    </button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // ... (rest of your functions unchanged, unless you need time zone for other date/time formatting) ...

        // (Rest of your script remains unchanged, including search, add/edit meeting, etc.)
    </script>
</body>
</html>
