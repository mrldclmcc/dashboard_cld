<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMCC Dashboard App</title>
    <style>
        /* --- CSS (unchanged) --- */
        * {margin: 0; padding: 0; box-sizing: border-box;}
        body {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #FBF5DE; color: #333; font-size: 18px; line-height: 1.4;}
        .container {max-width: 100%; margin: 0 auto; padding: 20px; padding-bottom: 100px;}
        .header {background: #3D74B6; color: white; padding: 20px; text-align: center; font-size: 24px; font-weight: bold; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1);}
        .date-nav {display: flex; justify-content: space-between; align-items: center; padding: 15px 0; background: white; margin: 20px 0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
        .date-nav button {background: #3D74B6; color: white; border: none; padding: 15px 20px; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; min-width: 60px;}
        .date-nav button:hover {background: #2a5a94;}
        .current-date {font-size: 20px; font-weight: bold; color: #3D74B6; text-align: center; flex: 1;}
        .meeting-card {background: white; border-radius: 16px; margin: 20px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; border-left: 6px solid #3D74B6;}
        .meeting-header {background: #EAC8A6; padding: 20px; color: #333;}
        .meeting-title {font-size: 22px; font-weight: bold; margin-bottom: 8px;}
        .meeting-time {font-size: 18px; color: #666;}
        .meeting-body {padding: 20px;}
        .action-button {display: block; width: 100%; padding: 18px; margin: 12px 0; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; text-align: center; text-decoration: none; transition: all 0.2s;}
        .maps-button {background: #3D74B6; color: white;}
        .maps-button:hover {background: #2a5a94; transform: translateY(-2px);}
        .url-button {background: #EAC8A6; color: #333;}
        .url-button:hover {background: #d4b895; transform: translateY(-2px);}
        .details-button {background: #DC3C22; color: white;}
        .details-button:hover {background: #b8321d; transform: translateY(-2px);}
        .fab {position: fixed; width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 24px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; transition: all 0.2s;}
        .fab:hover {transform: scale(1.1);}
        .add-fab {bottom: 20px; right: 20px; background: #DC3C22; color: white;}
        .search-fab {bottom: 20px; left: 20px; background: #3D74B6; color: white;}
        .modal {display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; overflow-y: auto;}
        .modal-content {background: white; margin: 20px; padding: 30px; border-radius: 16px; max-width: 600px; margin: 50px auto;}
        .modal-header {font-size: 24px; font-weight: bold; color: #3D74B6; margin-bottom: 20px; text-align: center;}
        .close-modal {float: right; font-size: 28px; font-weight: bold; color: #666; cursor: pointer; background: none; border: none; padding: 0; margin: -10px -10px 0 0;}
        .form-group {margin: 20px 0;}
        .form-group label {display: block; font-weight: bold; margin-bottom: 8px; color: #3D74B6;}
        .form-group input, .form-group textarea, .form-group select {width: 100%; padding: 15px; border: 2px solid #EAC8A6; border-radius: 8px; font-size: 16px; background: white;}
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {outline: none; border-color: #3D74B6;}
        .submit-button {background: #3D74B6; color: white; padding: 18px 30px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px;}
        .submit-button:hover {background: #2a5a94;}
        .loading {text-align: center; padding: 40px; color: #666; font-size: 18px;}
        .no-meetings {text-align: center; padding: 40px; color: #666; font-size: 18px; background: white; border-radius: 16px; margin: 20px 0;}
        .search-container {position: sticky; top: 80px; background: #FBF5DE; padding: 10px 0; z-index: 99;}
        .search-input {width: 100%; padding: 15px; border: 2px solid #3D74B6; border-radius: 12px; font-size: 18px; background: white;}
        .week-view {display: none; background: white; border-radius: 16px; padding: 20px; margin: 20px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1);}
        .week-nav {display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;}
        .week-days {display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;}
        .week-day {padding: 15px 5px; text-align: center; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.2s;}
        .week-day:hover {background: #EAC8A6;}
        .week-day.has-meeting {background: #3D74B6; color: white;}
        .week-day.selected {background: #DC3C22; color: white;}
        .file-upload {margin: 20px 0; padding: 20px; border: 2px dashed #3D74B6; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.2s;}
        .file-upload:hover {border-color: #DC3C22; background: rgba(220, 60, 34, 0.1);}
        .file-upload input {display: none;}
        @media (max-width: 768px) {
            .container {padding: 10px; padding-bottom: 100px;}
            .meeting-card {margin: 15px 0;}
            .action-button {padding: 20px; font-size: 20px;}
            .fab {width: 70px; height: 70px; font-size: 28px;}
        }
    </style>
</head>
<body>
    <div class="header">
        LMCC Dashboard App<br>
        <span style="font-size: 14px; color: #eac8a6;">
            All times shown in: <span id="userTimeZone"></span>
        </span>
    </div>
    <div class="container">
        <div class="date-nav">
            <button onclick="changeDate(-1)">‚Äπ Prev</button>
            <div class="current-date" id="currentDate">Today</div>
            <button onclick="changeDate(1)">Next ‚Ä∫</button>
        </div>
        <div class="search-container" id="searchContainer" style="display: none;">
            <input type="text" class="search-input" id="searchInput" placeholder="Search meetings..." 
                   oninput="searchMeetings(this.value)">
        </div>
        <div class="week-view" id="weekView">
            <div class="week-nav">
                <button onclick="changeWeek(-1)">‚Äπ Prev Week</button>
                <div id="weekTitle">Week View</div>
                <button onclick="changeWeek(1)">Next Week ‚Ä∫</button>
            </div>
            <div class="week-days" id="weekDays"></div>
        </div>
        <div id="meetingsContainer">
            <div class="loading">Loading meetings...</div>
        </div>
    </div>
    <button class="fab add-fab" onclick="showAddMeetingModal()">+</button>
    <button class="fab search-fab" onclick="toggleSearch()">üîç</button>
    <div class="modal" id="addMeetingModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('addMeetingModal')">√ó</button>
            <div class="modal-header">Add New Meeting</div>
            <div class="form-group">
                <label>Add Method:</label>
                <select id="addMethod" onchange="toggleAddMethod()">
                    <option value="manual">Manual Entry</option>
                    <option value="ics">Upload ICS File</option>
                    <option value="csv">Upload CSV/Excel</option>
                </select>
            </div>
            <div id="manualForm">
                <div class="form-group">
                    <label>Project Name:</label>
                    <input type="text" id="projectName" required>
                </div>
                <div class="form-group">
                    <label>Meeting Date:</label>
                    <input type="date" id="meetingDate" required>
                </div>
                <div class="form-group">
                    <label>Meeting Time:</label>
                    <input type="time" id="meetingTime" required>
                </div>
                <div class="form-group">
                    <label>Street Address:</label>
                    <input type="text" id="streetAddress">
                </div>
                <div class="form-group">
                    <label>City:</label>
                    <input type="text" id="city">
                </div>
                <div class="form-group">
                    <label>State:</label>
                    <input type="text" id="state">
                </div>
                <div class="form-group">
                    <label>Zip Code:</label>
                    <input type="text" id="zipCode">
                </div>
                <div class="form-group">
                    <label>BID Source ID:</label>
                    <input type="text" id="bidSourceId">
                </div>
                <div class="form-group">
                    <label>Project Description:</label>
                    <textarea id="projectDescription" rows="3"></textarea>
                </div>
                <button class="submit-button" onclick="addMeeting()">Add Meeting</button>
            </div>
            <div id="fileUploadForm" style="display: none;">
                <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" accept=".ics,.csv,.xlsx,.xls" onchange="handleFileUpload(this)">
                    <div>Click to upload file</div>
                    <div style="font-size: 14px; color: #666; margin-top: 10px;">
                        Supports ICS, CSV, and Excel files
                    </div>
                </div>
                <button class="submit-button" onclick="processUpload()" id="processUploadBtn" style="display: none;">
                    Process Upload
                </button>
            </div>
        </div>
    </div>
    <div class="modal" id="meetingDetailsModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('meetingDetailsModal')">√ó</button>
            <div class="modal-header">Meeting Details</div>
            <div id="meetingDetailsContent"></div>
        </div>
    </div>
    <div class="modal" id="editMeetingModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('editMeetingModal')">√ó</button>
            <div class="modal-header">Edit Meeting</div>
            <div id="editMeetingForm"></div>
        </div>
    </div>
    <script>
        // --- Global Variables ---
        let allMeetings = [];
        let filteredMeetings = [];
        let currentDate = new Date();
        let currentWeekStart = new Date();
        let isSearchMode = false;
        let uploadedFileData = null;

        // Detect user's local time zone
        const userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;

        const API_URL = 'https://script.google.com/macros/s/AKfycbwLO9Z7IEWbSNn0t87MUoSrEibjC8CtLiZ6xlHfEuPL1zoN07emOeZ8_KuWeoKrM9Se/exec';

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('userTimeZone').textContent = userTimeZone;
            loadMeetings();
            updateDateDisplay();
            setupWeekView();
        });

        // --- Week View Logic ---
        function setupWeekView() {
            // Calculate the start of the week (Sunday)
            const newWeekStart = new Date(currentDate);
            newWeekStart.setDate(newWeekStart.getDate() - newWeekStart.getDay());
            currentWeekStart = new Date(newWeekStart);
            updateWeekView();
        }

        function updateWeekView() {
            const weekView = document.getElementById('weekView');
            const weekDays = document.getElementById('weekDays');
            const weekTitle = document.getElementById('weekTitle');
            weekView.style.display = 'block';

            // Show Sunday-Saturday
            weekDays.innerHTML = '';
            let weekHasMeetings = false;
            for (let i = 0; i < 7; i++) {
                const day = new Date(currentWeekStart);
                day.setDate(currentWeekStart.getDate() + i);

                // Format for comparison
                const dateStr = formatDateForComparison(day);

                // Check if there are any meetings on this day
                const hasMeeting = allMeetings.some(m => formatDateForComparison(new Date(m['Bid Open Date'])) === dateStr);
                if (hasMeeting) weekHasMeetings = true;

                weekDays.innerHTML += `
                    <div class="week-day${hasMeeting ? ' has-meeting' : ''}${formatDateForComparison(day) === formatDateForComparison(currentDate) ? ' selected' : ''}"
                        onclick="setCurrentDate('${dateStr}')">
                        ${day.toLocaleDateString('en-US', { weekday: 'short' })}<br>
                        ${day.getDate()}
                    </div>
                `;
            }

            weekTitle.textContent = `Week of ${currentWeekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
            if (!weekHasMeetings) {
                weekDays.innerHTML += '<div style="grid-column: span 7; text-align: center; padding: 15px; color: #aaa;">No meetings scheduled this week</div>';
            }
        }

        function changeWeek(inc) {
            currentWeekStart.setDate(currentWeekStart.getDate() + inc * 7);
            currentDate = new Date(currentWeekStart);
            updateDateDisplay();
            updateWeekView();
            displayMeetings();
        }

        function setCurrentDate(dateStr) {
            // dateStr in 'YYYY-MM-DD' format
            const [year, month, day] = dateStr.split('-');
            currentDate = new Date(Number(year), Number(month) - 1, Number(day));
            updateDateDisplay();
            updateWeekView();
            displayMeetings();
        }

        // --- Meetings Logic ---
        async function loadMeetings() {
            try {
                const response = await fetch(`${API_URL}?action=getMeetings`);
                const data = await response.json();
                allMeetings = data.filter(meeting => meeting['Bid Open Date'] && meeting['Bid Open Time'] && meeting['Project Name']).map(meeting => ({
                    ...meeting,
                    'Project Description': meeting['Project Description'] || ''
                }));
                filteredMeetings = [...allMeetings];
                displayMeetings();
                updateWeekView();
            } catch (error) {
                console.error('Error loading meetings:', error);
                document.getElementById('meetingsContainer').innerHTML = 
                    '<div class="no-meetings">Error loading meetings. Please try again.</div>';
            }
        }

        function displayMeetings() {
            const container = document.getElementById('meetingsContainer');
            const currentDateStr = formatDateForComparison(currentDate);
            let meetingsToShow = isSearchMode ? filteredMeetings :
                filteredMeetings.filter(meeting => {
                    const meetingDate = new Date(meeting['Bid Open Date']);
                    return formatDateForComparison(meetingDate) === currentDateStr;
                });

            if (meetingsToShow.length === 0) {
                container.innerHTML = `<div class="no-meetings">
                    ${isSearchMode ? 'No meetings found' : 'No meetings scheduled for this date'}
                </div>`;
                return;
            }

            meetingsToShow.sort((a, b) => {
                const timeA = convertTimeToMinutes(a['Bid Open Time']);
                const timeB = convertTimeToMinutes(b['Bid Open Time']);
                return timeA - timeB;
            });

            container.innerHTML = meetingsToShow.map(meeting => createMeetingCard(meeting)).join('');
        }

        function createMeetingCard(meeting) {
            const meetingDate = new Date(meeting['Bid Open Date']);
            const dateDisplay = getDateDisplay(meetingDate);
            const time = formatMeetingTime(meeting['Bid Open Time']);
            const city = meeting['Bid Open City'] || 'Location TBD';
            const state = meeting['Bid Open State'] || '';
            const location = city + (state ? `, ${state}` : '');
            const fullAddress = [
                meeting['Bid Open Street'],
                meeting['Bid Open City'],
                meeting['Bid Open State'],
                meeting['Bid Open Zip']
            ].filter(Boolean).join(', ');
            const projectUrl = meeting['BID Source ID'] ? 
                `https://app.constructconnect.com/project/${meeting['BID Source ID']}/p?sourceType=3` : '#';

            return `
                <div class="meeting-card">
                    <div class="meeting-header">
                        <div class="meeting-title">${meeting['Project Name'] || 'Untitled Project'}</div>
                        <div class="meeting-time">${dateDisplay} ‚Ä¢ ${time} ‚Ä¢ ${location}</div>
                    </div>
                    <div class="meeting-body">
                        <button class="action-button maps-button" 
                                onclick="openMaps('${fullAddress}')" 
                                oncontextmenu="editAddress('${meeting['BID Source ID']}', '${fullAddress}'); return false;">
                            üìç Open in Maps
                        </button>
                        <button class="action-button url-button" 
                                onclick="openUrl('${projectUrl}')" 
                                oncontextmenu="copyUrl('${projectUrl}'); return false;">
                            üîó View Project
                        </button>
                        <button class="action-button details-button" 
                                onclick="showMeetingDetails('${meeting['BID Source ID']}')">
                            üìã View Details
                        </button>
                    </div>
                </div>
            `;
        }

        // --- Date/Time Utility Functions ---
        function formatMeetingTime(timeString) {
            if (!timeString) return 'Time TBD';
            try {
                const date = new Date(timeString);
                if (isNaN(date.getTime())) return 'Time TBD';
                return date.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true,
                    timeZone: userTimeZone
                });
            } catch (error) {
                console.error('Error parsing time:', timeString, error);
                return 'Time TBD';
            }
        }

        function extractTimeFromDateTime(timeString) {
            if (!timeString) return '';
            try {
                const date = new Date(timeString);
                if (isNaN(date.getTime())) return '';
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${hours}:${minutes}`;
            } catch (error) {
                console.error('Error extracting time:', timeString, error);
                return '';
            }
        }

        function formatDateForComparison(date) {
            // Use user's local date, ISO string (YYYY-MM-DD)
            return date.toLocaleDateString('en-CA', { timeZone: userTimeZone });
        }

        function getDateDisplay(date) {
            const today = new Date();
            const todayUser = new Date(today.toLocaleString('en-US', { timeZone: userTimeZone }));
            const dateUser = new Date(date.toLocaleString('en-US', { timeZone: userTimeZone }));
            const tomorrow = new Date(todayUser);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const yesterday = new Date(todayUser);
            yesterday.setDate(yesterday.getDate() - 1);

            if (formatDateForComparison(dateUser) === formatDateForComparison(todayUser)) {
                return 'Today';
            } else if (formatDateForComparison(dateUser) === formatDateForComparison(tomorrow)) {
                return 'Tomorrow';
            } else if (formatDateForComparison(dateUser) === formatDateForComparison(yesterday)) {
                return 'Yesterday';
            } else {
                return dateUser.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric'
                });
            }
        }

        function convertTimeToMinutes(timeString) {
            if (!timeString) return 0;
            try {
                const date = new Date(timeString);
                if (isNaN(date.getTime())) return 0;
                const userHours = date.toLocaleString('en-US', { 
                    hour: 'numeric', 
                    hour12: false,
                    timeZone: userTimeZone
                });
                const userMinutes = date.toLocaleString('en-US', { 
                    minute: 'numeric',
                    timeZone: userTimeZone
                });
                return parseInt(userHours) * 60 + parseInt(userMinutes);
            } catch (error) {
                console.error('Error parsing time for sorting:', timeString, error);
                return 0;
            }
        }

        // --- Navigation Functions ---
        function changeDate(days) {
            currentDate.setDate(currentDate.getDate() + days);
            updateDateDisplay();
            updateWeekView();
            displayMeetings();
        }

        function updateDateDisplay() {
            document.getElementById('currentDate').textContent = getDateDisplay(currentDate);
        }

        // --- Action Buttons ---
        function openMaps(address) {
            if (address && address !== 'undefined') {
                const encodedAddress = encodeURIComponent(address);
                const mapsUrl = `https://maps.google.com/?q=${encodedAddress}`;
                window.open(mapsUrl, '_blank');
            }
        }

        function openUrl(url) {
            if (url && url !== '#') {
                window.open(url, '_blank');
            }
        }

        function copyUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                alert('URL copied to clipboard!');
            });
        }

        function editAddress(bidSourceId, currentAddress) {
            const newAddress = prompt('Enter new address:', currentAddress);
            if (newAddress && newAddress !== currentAddress) {
                updateMeetingAddress(bidSourceId, newAddress);
            }
        }

        // --- Meeting Details Modal ---
        function showMeetingDetails(bidSourceId) {
            const meeting = allMeetings.find(m => String(m['BID Source ID']) === String(bidSourceId));
            if (!meeting) {
                console.error('Meeting not found for ID:', bidSourceId);
                alert('Meeting details not found');
                return;
            }
            const modal = document.getElementById('meetingDetailsModal');
            const content = document.getElementById('meetingDetailsContent');
            content.innerHTML = `
                <div style="line-height: 1.6;">
                    <h3 style="color: #3D74B6; margin-bottom: 15px;">${meeting['Project Name'] || 'Untitled Project'}</h3>
                    <p><strong>Date:</strong> ${new Date(meeting['Bid Open Date']).toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        timeZone: userTimeZone
                    })}</p>
                    <p><strong>Time:</strong> ${formatMeetingTime(meeting['Bid Open Time'])} (${userTimeZone})</p>
                    <p><strong>Location:</strong> ${[meeting['Bid Open Street'], meeting['Bid Open City'], meeting['Bid Open State'], meeting['Bid Open Zip']].filter(Boolean).join(', ')}</p>
                    <p><strong>Description:</strong> ${meeting['Project Description'] || 'No description available'}</p>
                    <p><strong>Bid Info:</strong> ${meeting['Bid Project Info'] || 'No additional info'}</p>
                    ${meeting['Low Bid Contractor'] ? `<p><strong>Low Bidder:</strong> ${meeting['Low Bid Contractor']} - $${meeting['Low Bid Amount'] || 'TBD'}</p>` : ''}
                    ${meeting['Low Bid Contractor 2'] ? `<p><strong>2nd Low Bidder:</strong> ${meeting['Low Bid Contractor 2']} - $${meeting['Low Bid Amount 2'] || 'TBD'}</p>` : ''}
                    ${meeting['Low Bid Contractor 3'] ? `<p><strong>3rd Low Bidder:</strong> ${meeting['Low Bid Contractor 3']} - $${meeting['Low Bid Amount 3'] || 'TBD'}</p>` : ''}
                    <button class="submit-button" onclick="editMeeting('${bidSourceId}')" style="margin-top: 20px;">
                        Edit Meeting
                    </button>
                </div>
            `;
            modal.style.display = 'block';
        }

        // --- Search ---
        function toggleSearch() {
            isSearchMode = !isSearchMode;
            const container = document.getElementById('searchContainer');
            const searchInput = document.getElementById('searchInput');
            if (isSearchMode) {
                container.style.display = 'block';
                searchInput.focus();
                filteredMeetings = [...allMeetings];
            } else {
                container.style.display = 'none';
                searchInput.value = '';
                filteredMeetings = [...allMeetings];
            }
            displayMeetings();
        }

        function searchMeetings(query) {
            if (!query.trim()) {
                filteredMeetings = [...allMeetings];
            } else {
                const searchTerm = query.toLowerCase();
                filteredMeetings = allMeetings.filter(meeting => {
                    return Object.values(meeting).some(value => 
                        value && value.toString().toLowerCase().includes(searchTerm)
                    );
                });
            }
            displayMeetings();
        }

        // --- Add/Edit Modal Logic (unchanged from your original) ---
        function showAddMeetingModal() {
            document.getElementById('addMeetingModal').style.display = 'block';
            document.getElementById('meetingDate').value = formatDateForComparison(currentDate);
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function toggleAddMethod() {
            const method = document.getElementById('addMethod').value;
            const manualForm = document.getElementById('manualForm');
            const fileForm = document.getElementById('fileUploadForm');
            if (method === 'manual') {
                manualForm.style.display = 'block';
                fileForm.style.display = 'none';
            } else {
                manualForm.style.display = 'none';
                fileForm.style.display = 'block';
            }
        }

        // ... addMeeting, editMeeting, updateMeeting functions go here (unchanged from your original) ...
        // For brevity, keep those as-is unless you need timezone handling for new values.

        // --- (Handle file uploads, etc, as in your original code) ---
        // --- Add any other original functions you had below ---

    </script>
</body>
</html>
